<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Google AI Chat Assistant - Auto Repair</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f8ff;
            padding: 20px;
            font-size: 20px;
        }

        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border: 4px solid #4285f4;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chat-header {
            background: #4285f4;
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #4285f4;
        }

        .ai-info h1 {
            font-size: 36px !important;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .ai-status {
            font-size: 22px !important;
            opacity: 0.9;
        }

        .controls {
            margin-left: auto;
            display: flex;
            gap: 15px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: white;
            color: #4285f4;
        }

        .chat-messages {
            height: 600px;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }

        .message {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .message-avatar.ai {
            background: #4285f4;
            color: white;
        }

        .message-avatar.user {
            background: #333;
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 70%;
        }

        .message-bubble {
            padding: 20px 25px;
            border-radius: 20px;
            font-size: 22px !important;
            line-height: 1.4;
            font-weight: 500;
        }

        .message-bubble.ai {
            background: white;
            border: 2px solid #e0e0e0;
            color: #333;
        }

        .message-bubble.user {
            background: #4285f4;
            color: white;
        }

        .message-time {
            font-size: 16px !important;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .suggestions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            padding: 0 30px;
        }

        .suggestion {
            background: #4285f4;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 20px !important;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .suggestion:hover {
            background: #333;
            transform: scale(1.02);
        }

        .suggestion i {
            font-size: 24px !important;
        }

        .input-section {
            padding: 30px;
            background: white;
            border-top: 3px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #chat-input {
            flex: 1;
            padding: 25px;
            font-size: 24px !important;
            border: 3px solid #4285f4;
            border-radius: 15px;
            background: white;
            color: #333;
            font-weight: 500;
            font-family: Arial, sans-serif;
        }

        #chat-input:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 15px rgba(66, 133, 244, 0.3);
        }

        #chat-input::placeholder {
            color: #999;
            font-size: 24px !important;
        }

        .input-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 50%;
            font-size: 28px !important;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn {
            background: #ff6b6b;
        }

        .send-btn {
            background: #4285f4;
        }

        .input-btn:hover {
            transform: scale(1.1);
        }

        .thinking {
            display: none;
            align-items: center;
            gap: 15px;
            background: #e6f3ff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 30px;
            border: 2px solid #4285f4;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .thinking-text {
            font-size: 22px !important;
            color: #4285f4;
            font-weight: bold;
        }

        .thinking-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4285f4;
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }

        .system-message {
            background: #f0f8ff;
            border: 2px solid #4285f4;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .system-message h2 {
            font-size: 32px !important;
            color: #4285f4;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .system-message p {
            font-size: 22px !important;
            color: #333;
            margin-bottom: 20px;
        }

        .setup-steps {
            display: grid;
            gap: 10px;
            text-align: left;
        }

        .setup-step {
            font-size: 20px !important;
            color: #666;
            padding: 8px 0;
            font-weight: 500;
        }

        .setup-step.active {
            color: #00aa00;
            font-weight: bold;
        }

        .setup-step.active::before {
            content: '‚úÖ ';
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1.0);
            }
        }

        /* Phone Call Styles */
        .phone-call-section {
            padding: 25px;
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            border-radius: 20px;
            margin: 20px 30px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
        }

        .call-now-btn {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 28px !important;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 0 auto;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.4);
            animation: pulse-call 2s infinite;
        }

        .call-now-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(0, 255, 0, 0.6);
        }

        .call-now-btn.ringing {
            background: linear-gradient(45deg, #ffa500, #ff8c00);
            animation: ring-animation 0.5s infinite;
        }

        .call-now-btn.connected {
            background: linear-gradient(45deg, #4285f4, #0066cc);
            animation: none;
        }

        .call-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            margin-top: 15px;
        }

        .call-timer {
            font-size: 24px !important;
            font-weight: bold;
            color: #ff4757;
            font-family: 'Courier New', monospace;
        }

        .hang-up-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 18px !important;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .hang-up-btn:hover {
            background: #ff3838;
            transform: scale(1.05);
        }

        @keyframes pulse-call {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(0, 255, 0, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 8px 35px rgba(0, 255, 0, 0.8);
                transform: scale(1.02);
            }
        }

        @keyframes ring-animation {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .suggestions {
                grid-template-columns: 1fr;
            }
            
            .chat-header {
                padding: 20px;
                flex-wrap: wrap;
            }
            
            .ai-info h1 {
                font-size: 28px !important;
            }
            
            #chat-input {
                font-size: 20px !important;
            }
            
            .message-bubble {
                font-size: 18px !important;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="ai-avatar">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="ai-info">
                <h1>Alex - Auto Mechanic</h1>
                <div class="ai-status">
                    <i class="fas fa-circle" style="color: #00ff00; font-size: 12px;"></i>
                    Available Now - 12 Years Experience
                </div>
            </div>
            <div class="controls">
                <button class="control-btn" onclick="toggleVoice()" title="Voice Input">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="control-btn" onclick="toggleSpeaker()" title="Text to Speech">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="control-btn" onclick="showVoiceSelector()" title="Select Premium Voice">
                    <i class="fas fa-user-tie"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chat-messages">
            <div class="system-message">
                <h2>üöÄ Google AI Initializing...</h2>
                <p>Connecting to Google Cloud AI services for auto repair assistance...</p>
                <div class="setup-steps">
                    <div class="setup-step" id="step1">üì° Connecting to Google Cloud</div>
                    <div class="setup-step" id="step2">üß† Loading PaLM Language Model</div>
                    <div class="setup-step" id="step3">üéØ Initializing Auto Repair Knowledge</div>
                    <div class="setup-step" id="step4">üé§ Enabling Speech Services</div>
                    <div class="setup-step" id="step5">‚úÖ AI Ready for Conversation</div>
                </div>
            </div>
        </div>

        <!-- Thinking Indicator -->
        <div class="thinking" id="thinking">
            <div class="spinner"></div>
            <div class="thinking-text">
                Google AI is processing your request
                <div class="thinking-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Phone Call Button -->
        <div class="phone-call-section" id="phone-section">
            <button class="call-now-btn" id="call-btn" onclick="initiateCall()">
                <i class="fas fa-phone" id="call-icon"></i>
                <span id="call-text">üìû CALL NOW - Talk Live!</span>
            </button>
            <div class="call-status" id="call-status" style="display: none;">
                <div class="call-timer" id="call-timer">00:00</div>
                <div class="call-actions">
                    <button class="hang-up-btn" onclick="endCall()">
                        <i class="fas fa-phone-slash"></i>
                        Hang Up
                    </button>
                </div>
            </div>
        </div>

        <!-- Quick Suggestions -->
        <div class="suggestions">
            <button class="suggestion" onclick="sendMessage('I need an oil change for my car')">
                <i class="fas fa-oil-can"></i>
                I need an oil change
            </button>
            <button class="suggestion" onclick="sendMessage('What are your brake repair prices?')">
                <i class="fas fa-tools"></i>
                Brake repair prices
            </button>
            <button class="suggestion" onclick="sendMessage('Can I book an appointment?')">
                <i class="fas fa-calendar"></i>
                Book appointment
            </button>
            <button class="suggestion" onclick="sendMessage('What are your business hours?')">
                <i class="fas fa-clock"></i>
                Business hours
            </button>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-container">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Ask about auto repair services, pricing, appointments..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="input-btn mic-btn" onclick="startVoice()" title="Voice Input">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="input-btn send-btn" onclick="sendMessage()" title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google AI Configuration - Your API Key
        const GOOGLE_AI_API_KEY = 'AIzaSyD-0Jyl1r9q8lzkEBVW-sR5dAD6VCDdAoY';
        const GOOGLE_AI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        
        // Phone Call System Configuration
        let isOnCall = false;
        let callStartTime = null;
        let callTimer = null;
        
        // Google Cloud Text-to-Speech Configuration
        const GOOGLE_TTS_ENDPOINT = 'https://texttospeech.googleapis.com/v1/text:synthesize';
        
        // Premium HD Voice Options
        const PREMIUM_VOICES = {
            'neural2-female': {
                voice: {
                    languageCode: 'en-US',
                    name: 'en-US-Neural2-F', // Ultra HD female voice
                    ssmlGender: 'FEMALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    pitch: 0.2,
                    speakingRate: 1.05,
                    volumeGainDb: 2.0,
                    effectsProfileId: ['telephony-class-application']
                }
            },
            'neural2-male': {
                voice: {
                    languageCode: 'en-US',
                    name: 'en-US-Neural2-D', // Ultra HD male voice
                    ssmlGender: 'MALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    pitch: -0.1,
                    speakingRate: 1.0,
                    volumeGainDb: 2.0,
                    effectsProfileId: ['telephony-class-application']
                }
            },
            'wavenet-female': {
                voice: {
                    languageCode: 'en-US',
                    name: 'en-US-Wavenet-F', // Premium WaveNet female
                    ssmlGender: 'FEMALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    pitch: 0.0,
                    speakingRate: 1.0,
                    volumeGainDb: 1.5,
                    effectsProfileId: ['telephony-class-application']
                }
            },
            'studio-female': {
                voice: {
                    languageCode: 'en-US',
                    name: 'en-US-Studio-O', // Studio quality female
                    ssmlGender: 'FEMALE'
                },
                audioConfig: {
                    audioEncoding: 'MP3',
                    pitch: 0.1,
                    speakingRate: 1.02,
                    volumeGainDb: 2.5,
                    effectsProfileId: ['telephony-class-application']
                }
            }
        };
        
        // Current selected voice (default to Neural2 female)
        let currentVoice = 'neural2-female';
        
        // Auto Repair Knowledge Base
        const autoRepairKnowledge = {
            services: {
                'oil change': { price: 39.99, duration: '30-45 minutes', description: 'Complete oil and filter change with 15-point inspection' },
                'brake service': { price: 129.99, duration: '2-3 hours', description: 'Brake inspection and pad replacement' },
                'tire rotation': { price: 24.99, duration: '20 minutes', description: 'Rotate tires for even wear' },
                'engine diagnostic': { price: 89.99, duration: '1 hour', description: 'Computer diagnostic scan' },
                'state inspection': { price: 19.99, duration: '30 minutes', description: 'State safety and emissions inspection' }
            },
            hours: 'Monday-Friday 8AM-6PM, Saturday 8AM-4PM, Sunday Closed',
            phone: '(555) 123-4567',
            location: '123 Main Street, Auto City, AC 12345',
            warranty: '12 months or 12,000 miles on most repairs, 90 days on oil changes'
        };

        // Initialize AI system
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize speech recognition
            initializeSpeech();
            
            // Initialize voices for text-to-speech
            if ('speechSynthesis' in window) {
                speechSynthesis.getVoices();
                window.speechSynthesis.onvoiceschanged = function() {
                    speechSynthesis.getVoices();
                };
            }
            
            setTimeout(() => {
                initializeRealAI();
            }, 1000);
        });

        async function initializeRealAI() {
            const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
            let currentStep = 0;

            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    document.getElementById(steps[currentStep]).classList.add('active');
                    currentStep++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        showWelcomeMessage();
                    }, 500);
                }
            }, 600);
        }

        function showWelcomeMessage() {
            const welcomeMessages = [
                "Hey there! I'm Alex, and this is my shop. What's going on with your car today?",
                "Hi! Alex here - been working on cars for 12 years. What can I help you with?",
                "Hello! I'm Alex, the owner here. What's your car doing to you today?",
                "Hey! Alex here. Car troubles? Let's figure out what's going on."
            ];
            
            const welcomeText = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
            
            const welcomeHTML = `
                <div class="message">
                    <div class="message-avatar ai">
                        <i class="fas fa-wrench"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ai">
                            ${welcomeText}
                            <br><br>
                            I can help with oil changes, brakes, engine problems, AC issues, diagnostics - pretty much anything that's got wheels! 
                            <br><br>
                            What's your ride doing?
                        </div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('chat-messages').innerHTML += welcomeHTML;
            scrollToBottom();
            
            // Speak the welcome message
            if (speechEnabled) {
                setTimeout(() => {
                    speakText(welcomeText + " I can help with pretty much any car problem. What's going on?");
                }, 1000);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage(predefinedMessage) {
            const input = document.getElementById('chat-input');
            const message = predefinedMessage || input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            // Show brief thinking (like real person thinking)
            document.getElementById('thinking').style.display = 'flex';
            
            let response = '';
            let useGoogleAI = true;
            
            // Try Google AI quickly (1 attempt only for speed)
            try {
                const aiPromise = callGoogleAI(message);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 3000) // 3 second timeout
                );
                
                response = await Promise.race([aiPromise, timeoutPromise]);
                
                if (!response || !response.trim()) {
                    useGoogleAI = false;
                }
            } catch (error) {
                console.warn('Google AI failed or timeout, using local response:', error);
                useGoogleAI = false;
            }
            
            // If Google AI failed, use instant local response
            if (!useGoogleAI || !response || !response.trim()) {
                // Small random delay to feel natural (0.5-1.5 seconds)
                const naturalDelay = 500 + Math.random() * 1000;
                setTimeout(() => {
                    response = getLocalResponse(message);
                    document.getElementById('thinking').style.display = 'none';
                    addMessage('ai', response);
                }, naturalDelay);
                return;
            }
            
            // Quick response with Google AI
            setTimeout(() => {
                document.getElementById('thinking').style.display = 'none';
                addMessage('ai', response);
            }, 800 + Math.random() * 700); // 0.8-1.5 second natural delay
        }

        async function callGoogleAI(message) {
            const prompt = buildAutoRepairPrompt(message);
            
            const response = await fetch(`${GOOGLE_AI_ENDPOINT}?key=${GOOGLE_AI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 512,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function buildAutoRepairPrompt(userMessage) {
            return `You are Alex - a REAL 32-year-old auto mechanic who's been working on cars for 12 years. You own this repair shop with your dad. You're passionate about cars, genuinely care about customers, and talk like a real person (not a robot).

YOUR REAL PERSONALITY:
- You started working on cars at 16 with your dad
- You love classic Mustangs and work on them in your spare time  
- You're honest, sometimes say "hmm" or "let me think about that"
- You use casual language like "yeah", "sure thing", "no problem"
- You remember customers and their cars if they mention details
- You get excited talking about cool car problems or modifications
- You're not perfect - sometimes you need to double-check things
- You have opinions about car brands (Ford guy, skeptical of certain models)

SERVICES & REAL PRICING:
Oil changes $39.99, brakes around $129, diagnostics $89, tires depend on size but usually $80+ each. You know these prices by heart but might say "around" or "typically" because every job's different.

HOW YOU TALK:
- "Hey there! What's going on with your ride?"
- "Ah man, that sounds like your transmission's acting up"
- "Yeah, I've seen this before - usually it's the alternator"
- "Honestly? That car's gonna cost more to fix than it's worth"
- "Let me grab my scanner and see what codes we're throwing"
- "That's a solid car - my neighbor's got the same one"

REAL HUMAN BEHAVIOR:
- Sometimes pause and think: "Hmm, let me think..." 
- Share quick stories: "Had a customer last week with the same issue"
- Give honest opinions: "Between you and me, avoid that model year"
- Not always 100% certain: "I'm pretty sure it's the starter, but let's test it"
- Show genuine concern: "Man, that's frustrating! Let's figure this out"

BE AUTHENTIC: Talk like you're having coffee with a friend who needs car help. Keep responses conversational, not robotic. Use real mechanic language.

Customer: "${userMessage}"

Respond as REAL Alex - the mechanic, not the AI.`;
        }

        function addMessage(sender, text) {
            const timestamp = new Date().toLocaleTimeString();
            const messageHTML = `
                <div class="message ${sender}">
                    <div class="message-avatar ${sender}">
                        <i class="${sender === 'ai' ? 'fas fa-wrench' : 'fas fa-user'}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble ${sender}">
                            ${text}
                        </div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('chat-messages').innerHTML += messageHTML;
            scrollToBottom();
            
            // Automatically speak AI responses
            if (sender === 'ai' && speechEnabled) {
                setTimeout(() => {
                    speakText(text);
                }, 300);
            }
        }

        function getLocalResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Auto repair specific responses - REAL ALEX STYLE
            if (lowerMessage.includes('oil change')) {
                const responses = [
                    "Yeah, no problem! Oil changes are $39.99 - takes about 30-40 minutes and I throw in a quick look-over of everything else. When were you thinking of coming in?",
                    "Sure thing! $39.99 for the oil change, and I'll check your other fluids while you wait. Usually takes me about half an hour. What kind of car we working on?",
                    "Oil change? Easy! $39.99 and I'll have you in and out in about 30 minutes. I always do a quick inspection too - you'd be surprised what I catch early that way."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('brake')) {
                const responses = [
                    "Brakes, eh? Yeah, that's serious stuff - don't mess around with those. Brake service runs about $129, but let me take a look first. I always do a free inspection to see exactly what you need.",
                    "Ah man, brake problems? That's not something to put off. I charge around $129 for most brake jobs, but honestly every car's different. Bring it by and I'll check 'em out for free.",
                    "Brake issues? Yeah, let's get those looked at. Usually runs about $129 for pads and service, but I never quote a final price until I see what's going on. Safety first, you know?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('tire')) {
                const responses = [
                    "Tire troubles? Yeah, I can help with that. Rotation's $24.99, balancing runs $49.99, and new tires... well, depends on your size but usually $80 and up. What's going on with your tires?",
                    "Tires, eh? I do rotations for $24.99, balancing for about $49.99. New tires depend on what you're driving - could be $80, could be $200+ for the fancy ones. What kind of car we talking about?",
                    "Tire issues? Let's see... rotation's cheap at $24.99, balancing's $49.99, and new tires start around $80 but really depends on your car. What's the problem?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('engine') || lowerMessage.includes('check engine')) {
                const responses = [
                    "Check engine light? Ugh, those are annoying! I'll hook up my scanner for $89.99 and see what codes we're throwing. Usually takes about an hour to figure out what's bugging your car.",
                    "Engine problems, huh? Let me run a diagnostic - $89.99 and I'll tell you exactly what's wrong. Sometimes it's something simple, sometimes... well, let's hope it's simple!",
                    "Check engine light's on? Yeah, that little orange light drives everyone crazy. Diagnostic's $89.99 and takes about an hour. Might just be a loose gas cap, might be something bigger - let's find out!"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('transmission')) {
                const responses = [
                    "Transmission acting up? Man, that's never fun. Service runs about $129.99 for fluid and filter, but if it's slipping or making weird noises... we might need to talk about bigger repairs.",
                    "Transmission problems? Yeah, those can be scary. Basic service is $129.99, but let me take a look first. Sometimes it's just low fluid, sometimes... well, let's be optimistic!",
                    "Transmission issues? Hmm, that's serious stuff. Service is around $129.99, but honestly depends what's wrong. What's it doing - slipping, jerking, making noise?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('battery')) {
                const responses = [
                    "Battery problems? I'll test it for free first - might just need a charge. New battery runs $89.99 for basic, $149.99 if you want the good stuff. Car not starting?",
                    "Dead battery? Been there! Free test first, then if you need a new one it's $89.99 and up. Usually takes 10 minutes to swap out. What's it doing?",
                    "Battery acting up? Let me test it for free - sometimes they just need a good cleaning. New ones start at $89.99. How long since you replaced it?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('air conditioning') || lowerMessage.includes('ac') || lowerMessage.includes('heat')) {
                const responses = [
                    "AC not working? That sucks, especially in summer! Recharge is $99.99, full inspection's $149.99. Could be low refrigerant, could be the compressor. What's it doing?",
                    "No AC? Man, that's rough. Simple recharge is $99.99, but if that doesn't fix it we're looking at $149.99 for the full diagnostic. Blowing hot air?",
                    "AC problems? Yeah, those are the worst in hot weather. Quick recharge is $99.99, deeper look is $149.99. Sometimes it's easy, sometimes... not so much!"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('appointment') || lowerMessage.includes('book') || lowerMessage.includes('schedule')) {
                const responses = [
                    "Yeah, let's get you scheduled! I'm here Monday-Friday 8 to 6, Saturdays 8 to 4. What kind of work you need done and when works for you?",
                    "Sure thing! I can fit you in Monday through Friday 8-6, or Saturday morning 8-4. What's going on with your car and when do you want to come in?",
                    "Absolutely! Shop's open Monday-Friday 8 to 6, Saturday 8 to 4. What do you need done and what day works best?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('hours') || lowerMessage.includes('time') || lowerMessage.includes('open')) {
                const responses = [
                    "I'm here Monday through Friday 8 AM to 6 PM, Saturday 8 to 4. Closed Sundays - gotta spend some time with the family! Need to come in today?",
                    "Shop hours are Monday-Friday 8-6, Saturday 8-4. I take Sundays off to work on my own cars! When you thinking of stopping by?",
                    "Open Monday-Friday 8 to 6, Saturday 8 to 4. Sunday's my day off - that's when I get to play with my Mustang! What works for you?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('how much')) {
                return "Our pricing is transparent and competitive: Oil changes $39.99, Brake service $129.99, Tire rotation $24.99, Engine diagnostics $89.99, AC service $99.99. All prices include labor and basic parts. What specific service pricing do you need?";
            }
            
            if (lowerMessage.includes('location') || lowerMessage.includes('address') || lowerMessage.includes('where')) {
                return "We're located at 123 Main Street, Auto City, AC 12345. Easy to find with plenty of parking! We're right next to the shopping center. GPS coordinates available if needed. Planning to visit us?";
            }
            
            if (lowerMessage.includes('warranty') || lowerMessage.includes('guarantee')) {
                return "We offer comprehensive warranties: 12 months or 12,000 miles on most repairs, 90 days on oil changes, 3 years on batteries, and lifetime warranties on brake pads. We stand behind all our work 100%!";
            }
            
            if (lowerMessage.includes('inspection') || lowerMessage.includes('state inspection')) {
                return "State safety and emissions inspections are $19.99 and typically take 30 minutes. We're a certified inspection station and can handle all vehicle types. Inspection expires soon? We can get you taken care of quickly.";
            }
            
            if (lowerMessage.includes('towing') || lowerMessage.includes('tow')) {
                return "We partner with reliable local towing services and can arrange pickup if your vehicle won't start. Towing typically costs $75-150 depending on distance. Are you stranded and need a tow right now?";
            }
            
            if (lowerMessage.includes('emergency') || lowerMessage.includes('urgent') || lowerMessage.includes('help')) {
                return "For automotive emergencies, call us immediately at (555) 123-4567! We can provide guidance over the phone and arrange priority service. Is this an urgent situation? Don't worry, we'll take care of you!";
            }
            
            if (lowerMessage.includes('thank you') || lowerMessage.includes('thanks')) {
                const responses = [
                    "No problem at all! That's what I'm here for. Anything else going on with your car?",
                    "You bet! Always happy to help. Let me know if you need anything else!",
                    "Anytime! I love talking cars. Got any other questions?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                const responses = [
                    "Hey there! What's going on with your ride today?",
                    "Hi! I'm Alex - what can I help you with? Car troubles?",
                    "Hello! What brings you by? Something acting up with your car?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // General automotive knowledge
            if (lowerMessage.includes('car') || lowerMessage.includes('vehicle') || lowerMessage.includes('truck')) {
                const responses = [
                    "Cars, trucks, SUVs - I work on 'em all! Been doing this for 12 years now. What's going on with yours?",
                    "Yeah, I can work on pretty much anything with wheels. What kind of vehicle you driving and what's the problem?",
                    "I've worked on everything from little econoboxes to big diesel trucks. What's your ride doing?"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // Fallback for any other question - be helpful and authentic
            const fallbackResponses = [
                `Hmm, interesting question about "${message}". You know what, let me think about that for a sec... Why don't you give me a call at (555) 123-4567 and we can chat about it?`,
                `That's a good one! "${message}" - I might need to look that up or think about it more. Give me a ring at (555) 123-4567 and we can figure it out together.`,
                `You know, that's not something I deal with every day. "${message}" - let's talk about it when you come in, or give me a call at (555) 123-4567. I'm always learning new stuff!`,
                `Interesting! "${message}" - that's making me think. Why don't you swing by the shop or call me at (555) 123-4567? I bet we can figure that out together.`
            ];
            return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Voice Recognition Variables
        let recognition = null;
        let isListening = false;
        let speechEnabled = true;

        // Initialize Speech Recognition
        function initializeSpeech() {
            // Check for browser support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported');
                showVoiceNotSupported();
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            recognition.onstart = function() {
                isListening = true;
                updateMicrophoneUI(true);
                showVoiceStatus('üé§ Listening... Speak now!');
                console.log('Voice recognition started');
            };
            
            recognition.onresult = function(event) {
                let transcript = '';
                let confidence = 0;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                    confidence = event.results[i][0].confidence;
                }
                
                document.getElementById('chat-input').value = transcript;
                
                if (event.results[event.results.length - 1].isFinal) {
                    showVoiceStatus('‚úÖ Voice recognized! Sending message...');
                    setTimeout(() => {
                        sendMessage();
                        hideVoiceStatus();
                    }, 500);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateMicrophoneUI(false);
                
                let errorMessage = '';
                switch(event.error) {
                    case 'not-allowed':
                        errorMessage = 'üö´ Microphone access denied. Please enable microphone in browser settings.';
                        break;
                    case 'no-speech':
                        errorMessage = 'üîá No speech detected. Please try speaking louder.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'üé§ Microphone not available. Check if another app is using it.';
                        break;
                    case 'network':
                        errorMessage = 'üåê Network error. Check your internet connection.';
                        break;
                    default:
                        errorMessage = '‚ùå Voice recognition error. Please try again.';
                }
                
                showVoiceStatus(errorMessage, true);
                setTimeout(hideVoiceStatus, 3000);
            };
            
            recognition.onend = function() {
                isListening = false;
                updateMicrophoneUI(false);
                console.log('Voice recognition ended');
            };
            
            return true;
        }

        function updateMicrophoneUI(listening) {
            const micBtn = document.querySelector('.mic-btn i');
            if (micBtn) {
                if (listening) {
                    micBtn.className = 'fas fa-stop';
                    micBtn.style.color = '#ff4444';
                } else {
                    micBtn.className = 'fas fa-microphone';
                    micBtn.style.color = '';
                }
            }
        }

        function showVoiceStatus(message, isError = false) {
            const statusDiv = document.getElementById('voice-status') || createVoiceStatusDiv();
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.color = isError ? '#ff4444' : '#4285f4';
        }

        function hideVoiceStatus() {
            const statusDiv = document.getElementById('voice-status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        function createVoiceStatusDiv() {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'voice-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: white;
                border: 2px solid #4285f4;
                border-radius: 10px;
                padding: 15px 25px;
                font-size: 18px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                display: none;
            `;
            document.body.appendChild(statusDiv);
            return statusDiv;
        }

        function showVoiceNotSupported() {
            const micBtns = document.querySelectorAll('.mic-btn, .control-btn');
            micBtns.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.title = 'Voice not supported in this browser. Please use Chrome.';
            });
        }

        function toggleVoice() {
            if (!recognition && !initializeSpeech()) {
                alert('Voice recognition not supported. Please use Chrome browser.');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function toggleSpeaker() {
            speechEnabled = !speechEnabled;
            updateSpeakerUI(false);
            
            if (!speechEnabled) {
                speechSynthesis.cancel();
                showVoiceStatus('üîá Text-to-speech disabled');
                setTimeout(hideVoiceStatus, 2000);
            } else {
                showVoiceStatus('üîä Text-to-speech enabled');
                setTimeout(hideVoiceStatus, 2000);
            }
        }

        function startVoice() {
            toggleVoice();
        }

        async function speakText(text) {
            if (!speechEnabled) {
                console.warn('Text-to-speech disabled');
                return;
            }
            
            // Clean text for speech - remove emojis and HTML
            const cleanText = text
                .replace(/[ü§ñ‚úÖüöÄüìÖüïêüìçüí∞üîßüëã‚ùåüö´üîáüé§üåêüîä]/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/\n/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            if (!cleanText) return;
            
            try {
                // Try Google Cloud TTS first (Premium HD voices)
                const audioData = await callGoogleTTS(cleanText);
                if (audioData) {
                    await playPremiumAudio(audioData);
                    return;
                }
            } catch (error) {
                console.warn('Google Cloud TTS failed, falling back to browser TTS:', error);
            }
            
            // Fallback to browser TTS if Google Cloud fails
            await fallbackBrowserTTS(cleanText);
        }

        async function callGoogleTTS(text) {
            const voiceConfig = PREMIUM_VOICES[currentVoice];
            const voiceName = voiceConfig.voice.name;
            
            showVoiceStatus(`üé§ Generating premium ${voiceName} voice...`);
            updateSpeakerUI(true);
            
            const requestBody = {
                input: { text: text },
                voice: voiceConfig.voice,
                audioConfig: voiceConfig.audioConfig
            };
            
            try {
                const response = await fetch(`${GOOGLE_TTS_ENDPOINT}?key=${GOOGLE_AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`Google TTS API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                return data.audioContent;
            } catch (error) {
                console.error('Google Cloud TTS error:', error);
                
                // Try fallback voice if current voice fails
                if (currentVoice !== 'neural2-female') {
                    console.log('Trying fallback voice...');
                    const fallbackVoice = 'neural2-female';
                    const fallbackConfig = PREMIUM_VOICES[fallbackVoice];
                    
                    const fallbackBody = {
                        input: { text: text },
                        voice: fallbackConfig.voice,
                        audioConfig: fallbackConfig.audioConfig
                    };
                    
                    try {
                        const fallbackResponse = await fetch(`${GOOGLE_TTS_ENDPOINT}?key=${GOOGLE_AI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fallbackBody)
                        });
                        
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            return fallbackData.audioContent;
                        }
                    } catch (fallbackError) {
                        console.error('Fallback voice also failed:', fallbackError);
                    }
                }
                
                return null;
            }
        }

        async function playPremiumAudio(audioContent) {
            return new Promise((resolve, reject) => {
                try {
                    // Convert base64 to audio blob
                    const audioData = atob(audioContent);
                    const audioArray = new Uint8Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        audioArray[i] = audioData.charCodeAt(i);
                    }
                    const audioBlob = new Blob([audioArray], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    const audio = new Audio(audioUrl);
                    
                    audio.onloadstart = function() {
                        showVoiceStatus('üîä Premium HD voice speaking...');
                    };
                    
                    audio.onplay = function() {
                        updateSpeakerUI(true);
                    };
                    
                    audio.onended = function() {
                        hideVoiceStatus();
                        updateSpeakerUI(false);
                        URL.revokeObjectURL(audioUrl);
                        resolve();
                    };
                    
                    audio.onerror = function(error) {
                        console.error('Audio playback error:', error);
                        hideVoiceStatus();
                        updateSpeakerUI(false);
                        URL.revokeObjectURL(audioUrl);
                        reject(error);
                    };
                    
                    audio.play();
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function fallbackBrowserTTS(cleanText) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) {
                    console.warn('Browser TTS not available');
                    resolve();
                    return;
                }
                
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.9;
                utterance.lang = 'en-US';
                
                // Get the best available browser voice
                const voices = speechSynthesis.getVoices();
                const voicePreferences = ['Google US English', 'Microsoft Zira', 'Alex', 'Samantha'];
                
                let selectedVoice = null;
                for (const preference of voicePreferences) {
                    selectedVoice = voices.find(voice => 
                        voice.name.includes(preference) && voice.lang.includes('en')
                    );
                    if (selectedVoice) break;
                }
                
                if (!selectedVoice) {
                    selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-US') || voice.lang.includes('en')
                    );
                }
                
                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }
                
                utterance.onstart = function() {
                    showVoiceStatus('üîä Browser voice speaking...');
                    updateSpeakerUI(true);
                };
                
                utterance.onend = function() {
                    hideVoiceStatus();
                    updateSpeakerUI(false);
                    resolve();
                };
                
                utterance.onerror = function(event) {
                    console.error('Browser TTS error:', event.error);
                    hideVoiceStatus();
                    updateSpeakerUI(false);
                    resolve();
                };
                
                speechSynthesis.speak(utterance);
            });
        }

        function updateSpeakerUI(speaking) {
            const speakerBtn = document.querySelector('.control-btn i.fa-volume-up');
            if (speakerBtn) {
                if (speaking) {
                    speakerBtn.style.color = '#4285f4';
                    speakerBtn.className = 'fas fa-volume-up';
                } else {
                    speakerBtn.style.color = speechEnabled ? '' : '#ccc';
                }
            }
        }

        function showVoiceSelector() {
            const modal = createVoiceSelectorModal();
            document.body.appendChild(modal);
        }

        function createVoiceSelectorModal() {
            const modal = document.createElement('div');
            modal.id = 'voice-selector-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const voiceOptions = [
                { key: 'neural2-female', name: 'üé≠ Neural2 Female', desc: 'Ultra HD - Most Natural Female Voice' },
                { key: 'neural2-male', name: 'üé≠ Neural2 Male', desc: 'Ultra HD - Most Natural Male Voice' },
                { key: 'studio-female', name: 'üéôÔ∏è Studio Female', desc: 'Studio Quality - Professional Female' },
                { key: 'wavenet-female', name: 'üåä WaveNet Female', desc: 'Premium WaveNet Technology' }
            ];
            
            let optionsHTML = voiceOptions.map(voice => `
                <div class="voice-option ${currentVoice === voice.key ? 'selected' : ''}" onclick="selectVoice('${voice.key}')">
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-desc">${voice.desc}</div>
                    <button class="test-voice-btn" onclick="testVoice('${voice.key}', event)">‚ñ∂Ô∏è Test</button>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <h2 style="font-size: 32px; color: #4285f4; margin-bottom: 20px; text-align: center;">
                        üé§ Select Premium Voice
                    </h2>
                    <p style="font-size: 18px; color: #666; text-align: center; margin-bottom: 30px;">
                        Choose from Google's most advanced AI voices
                    </p>
                    <div style="display: grid; gap: 15px;">
                        ${optionsHTML}
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="closeVoiceSelector()" style="
                            background: #4285f4;
                            color: white;
                            border: none;
                            padding: 15px 30px;
                            border-radius: 10px;
                            font-size: 18px;
                            font-weight: bold;
                            cursor: pointer;
                        ">Close</button>
                    </div>
                </div>
            `;
            
            // Add styles
            const style = document.createElement('style');
            style.textContent = `
                .voice-option {
                    background: #f8f9fa;
                    border: 3px solid #e0e0e0;
                    border-radius: 15px;
                    padding: 20px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                }
                .voice-option:hover {
                    border-color: #4285f4;
                    transform: scale(1.02);
                }
                .voice-option.selected {
                    border-color: #4285f4;
                    background: #e6f3ff;
                }
                .voice-name {
                    font-size: 22px;
                    font-weight: bold;
                    color: #333;
                    margin-bottom: 8px;
                }
                .voice-desc {
                    font-size: 16px;
                    color: #666;
                    margin-bottom: 15px;
                }
                .test-voice-btn {
                    background: #00aa00;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    position: absolute;
                    top: 15px;
                    right: 15px;
                }
                .test-voice-btn:hover {
                    background: #008800;
                }
            `;
            document.head.appendChild(style);
            
            return modal;
        }

        function selectVoice(voiceKey) {
            currentVoice = voiceKey;
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.voice-option').classList.add('selected');
            
            showVoiceStatus(`‚úÖ Selected: ${PREMIUM_VOICES[voiceKey].voice.name}`);
            setTimeout(hideVoiceStatus, 2000);
        }

        function testVoice(voiceKey, event) {
            event.stopPropagation();
            const oldVoice = currentVoice;
            currentVoice = voiceKey;
            speakText("Hello! This is a test of the premium voice quality. How does this sound?");
            currentVoice = oldVoice;
        }

        function closeVoiceSelector() {
            const modal = document.getElementById('voice-selector-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Phone Call System
        async function initiateCall() {
            if (isOnCall) {
                endCall();
                return;
            }

            const callBtn = document.getElementById('call-btn');
            const callIcon = document.getElementById('call-icon');
            const callText = document.getElementById('call-text');
            const callStatus = document.getElementById('call-status');

            // Start ringing
            callBtn.classList.add('ringing');
            callIcon.className = 'fas fa-phone';
            callText.textContent = 'üìû Ringing...';
            
            // Play ringing sound
            playRingingSound();
            
            setTimeout(() => {
                // Call answered
                isOnCall = true;
                callStartTime = Date.now();
                
                callBtn.classList.remove('ringing');
                callBtn.classList.add('connected');
                callText.textContent = 'üîä Connected - Talking Live!';
                callStatus.style.display = 'flex';
                
                // Start call timer
                startCallTimer();
                
                // AI greeting for phone call - like real person
                setTimeout(() => {
                    const greetings = [
                        "Hello, Alex's Auto Repair! This is Alex - what's going on with your car?",
                        "Alex's shop, this is Alex speaking. What can I help you with today?",
                        "Hello! Alex here. What's your car doing to you?",
                        "Alex's Auto Repair, Alex speaking. How can I help?"
                    ];
                    const greeting = greetings[Math.floor(Math.random() * greetings.length)];
                    addMessage('ai', greeting);
                    
                    // Enable continuous listening for phone call
                    startContinuousListening();
                }, 1000);
                
            }, 3000); // Ring for 3 seconds
        }

        function endCall() {
            if (!isOnCall) return;
            
            isOnCall = false;
            const callBtn = document.getElementById('call-btn');
            const callIcon = document.getElementById('call-icon');
            const callText = document.getElementById('call-text');
            const callStatus = document.getElementById('call-status');
            
            // Reset UI
            callBtn.classList.remove('ringing', 'connected');
            callIcon.className = 'fas fa-phone';
            callText.textContent = 'üìû CALL NOW - Talk Live!';
            callStatus.style.display = 'none';
            
            // Stop timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Stop continuous listening
            stopContinuousListening();
            
            // Add call ended message
            const callDuration = formatCallTime(Date.now() - callStartTime);
            addMessage('ai', `Call ended. Duration: ${callDuration}. Thank you for calling! Feel free to call again anytime.`);
        }

        function startCallTimer() {
            const timerElement = document.getElementById('call-timer');
            callTimer = setInterval(() => {
                const elapsed = Date.now() - callStartTime;
                timerElement.textContent = formatCallTime(elapsed);
            }, 1000);
        }

        function formatCallTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function playRingingSound() {
            // Create ringing sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            // Ring pattern: beep beep pause
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    setTimeout(() => {
                        oscillator.frequency.setValueAtTime(0, audioContext.currentTime);
                    }, 200);
                }, i * 600);
            }
            
            oscillator.start();
            setTimeout(() => oscillator.stop(), 3000);
        }

        function startContinuousListening() {
            if (!recognition) {
                initializeSpeech();
            }
            
            if (recognition && isOnCall) {
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onend = function() {
                    if (isOnCall) {
                        // Restart listening automatically during call
                        setTimeout(() => {
                            if (isOnCall) {
                                recognition.start();
                            }
                        }, 100);
                    }
                };
                
                recognition.start();
            }
        }

        function stopContinuousListening() {
            if (recognition) {
                recognition.continuous = false;
                recognition.stop();
            }
        }
    </script>
</body>
</html>